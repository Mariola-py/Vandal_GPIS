{% load static %}
<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VANDAL</title>
  <!-- Enlace al archivo de estilos principal -->
  <link rel="stylesheet" href="../../static/css/styles.css">
  <link rel="stylesheet" href="../../static/css/blog.css">
</head>

<body>
  <!-- Header social + login -->
  <nav class="navbar">
    <div class="language-switch">
      <a href="/es" class="lang-option">ES</a>
      <span>|</span>
      <a href="/en" class="lang-option">EN</a>
    </div>
    {% if user.is_authenticated %}
    <div class="login-dropdown">
      <button class="dropdown-button">Bienvenido {{ user.username }}</button>
      <div class="dropdown-content">
        <a href="/dashboard/{{ user.userrole.role }}/">Ir a mi panel</a>
        <a href="/logout/">Cerrar sesión</a>
      </div>
    </div>
    {% else %}
    <div class="login-icon">
      <a href="/login/">
        <img class="social-icons" src="{% static 'images/Logos/Login_icon.png' %}" alt="Login Icon">
      </a>
    </div>
    {% endif %}
  </nav>

  <!-- Logo principal -->
  <nav class="navbar">
    <div>
      <a href="/">
        <img class="logo" src="{% static 'images/Logos/vandal_logo.PNG' %}" alt="Vandal Logo">
      </a>
    </div>
  </nav>

  <!-- Navbar principal -->
  <nav class="navbar">
    <ul>
      <li><a href="/">INICIO</a></li>
      <li><a href="/blog">Blog</a></li>
      <li><a href="/redactores">Equipo</a></li>
      <li><a href="/videos">Vídeos</a></li>
      <li><a href="/calendario">Calendario</a></li>
      <li><a href="/ranking">Ranking</a></li>
    </ul>
  </nav>

<!-- Sección de comentarios -->
<section id="comments-section">
  <h2 class="titulo-post">{{ post.title }}</h2>

  <!-- Comentario principal desde el post -->
  <div class="comment-block principal">
    <div class="comment-header">
      <div class="avatar"></div>
      <div class="user-info">
        <span class="username">{{ post.author.username }}</span>
        <span class="user-role">Autor</span>
      </div>
    </div>
    <div class="comment-meta">
      <span class="comment-number">#0</span>
      <span class="comment-time">Publicado hace {{ post.created_at|timesince }}</span>
    </div>
    <div class="comment-content">
      {{ post.content|linebreaks }}
    </div>
    {% if post.image %}
      <div class="comment-image">
        <img src="{{ post.image.url }}" alt="Imagen del post">
      </div>
    {% endif %}
  </div>

  <!-- Lista de comentarios -->
  <div class="comments-list">
    {% if comments %}
      {% for comment in comments %}
      <div class="comment-block">
        <div class="comment-header">
          <div class="avatar"></div>
          <div class="user-info">
            <span class="username">{{ comment.user.username }}</span>
            <span class="user-role">
              {% with comment.user.userrole.role as rol %}
                ROL ({{ rol|title }})
              {% endwith %}
            </span>
          </div>
        </div>
        <div class="comment-meta">
          <span class="comment-number">#{{ forloop.counter }}</span>
          <span class="comment-time">Enviado hace {{ comment.created_at|timesince }}</span>
        </div>
        <div class="comment-content">{{ comment.content }}</div>

        <!-- Formulario de respuesta -->
        {% if user.is_authenticated %}
        <!-- Botón para mostrar el formulario -->
        <button class="show-reply-btn" onclick="toggleReplyForm(this)">Responder</button>

        <!-- Formulario oculto por defecto -->
        <form method="post" class="reply-form" style="display: none; margin-top: 10px;">
          {% csrf_token %}
          {{ form.content }}
          <input type="hidden" name="parent_id" value="{{ comment.id }}">
          <button type="submit">Enviar respuesta</button>
        </form>

        {% endif %}

        <!-- Respuestas anidadas -->
        {% for reply in comment.replies.all %}
        <div class="reply-block">
          <strong>{{ reply.user.username }}</strong>
          <p>{{ reply.content }}</p>
          <span>{{ reply.created_at|timesince }} atrás</span>
        </div>
        {% endfor %}
      </div>
      {% endfor %}
    {% else %}
      <p>No hay comentarios sobre el blog aún. Sé el primero.</p>
    {% endif %}
  </div>

  <!-- Nuevo comentario raíz -->
  {% if user.is_authenticated %}
  <form method="POST" class="comment-form">
    {% csrf_token %}
    {{ form.content }}
    <input type="hidden" name="parent_id" value="">  <!-- comentario raíz -->
    <button type="submit">Enviar comentario</button>
  </form>
  {% else %}
  <p><a href="{% url 'login' %}">Inicia sesión</a> para dejar un comentario.</p>
  {% endif %}
</section>




  <!-- Sección de contacto -->
  <div style="text-align: center;">
    <h1>¿Encontraste un bug en tu aventura?</h1>
    <p>Cuéntanos para que podamos lanzar un hechizo de corrección.</p>
  </div>
  <div style="text-align: center; margin: 20px 0;">
    <a href="/contacto" class="contact-button">Contáctanos</a>
  </div>

  <!-- Footer -->
  <footer class="footer">
    <div class="footer-logo">
      <img class="logo-footer" src="{% static 'images/Logos/vandal_logo.PNG' %}" alt="Vandal Logo Footer">
    </div>
    </br>
    <nav class="footer-nav">
      <a href="/legal">Aviso legal</a>
      <a href="/">Política de cookies</a>
      <a href="/publicidad">Publicidad/Advertising</a>
      <a href="/contacto">Trabaja con nosotros</a>
    </nav>
    </br>
    <div class="footer-bottom">
      Copyright Vandal © 2025 - Prohibida la reproducción total o parcial de estos contenidos sin el permiso expreso de los autores.
    </div>
  </footer>

  <script>
    function toggleReplyForm(button) {
      const form = button.nextElementSibling;
      if (form.style.display === "none") {
        form.style.display = "block";
        button.style.display = "none";
      }
    }
  </script>
  
</body>

</html>